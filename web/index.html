<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HamsterPi 监控台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Sora:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/web/styles.css" />
  </head>
  <body>
    <div class="bg-orb orb-a"></div>
    <div class="bg-orb orb-b"></div>
    <div class="bg-grid"></div>

    <main class="page">
      <header class="hero">
        <div>
          <p class="eyebrow" data-i18n="hero_eyebrow">仓鼠行为智能分析</p>
          <h1 data-i18n="hero_title">HamsterPi 监控台</h1>
          <p class="sub" data-i18n="hero_sub">
            面向 Pi Zero 2W 的低内存方案，支持虚拟数据、初始化圈区、持续循环录制、行为与环境分析。
          </p>
        </div>
        <div class="hero-actions">
          <button id="refresh-btn" class="btn btn-solid" data-i18n="btn_refresh">刷新虚拟数据</button>
          <button id="toggle-auto-btn" class="btn btn-ghost" data-i18n="btn_auto_on">自动刷新：开</button>
          <button id="init-zones-btn" class="btn btn-ghost" data-i18n="btn_init">初始化圈区</button>
          <button id="settings-btn" class="btn btn-ghost" data-i18n="btn_settings">设置</button>
          <button id="theme-toggle-btn" class="btn btn-ghost btn-theme" type="button">切换到浅色</button>
          <div class="hero-meta">
            <p class="stamp"><span data-i18n="label_generated_at">生成时间：</span><span id="generated-at">-</span></p>
            <p class="stamp"><span data-i18n="label_runtime">运行配置：</span><span id="runtime-profile">-</span></p>
          </div>
        </div>
      </header>

      <nav class="view-tabs" id="view-tabs" role="tablist" aria-label="Dashboard Tabs">
        <button
          id="tab-overview"
          class="view-tab active"
          type="button"
          role="tab"
          aria-selected="true"
          aria-controls="tab-panel-overview"
          data-tab-target="overview"
          data-i18n-aria-label="tab_overview"
        >
          <span class="view-tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
              <path d="M3 10.5L12 3l9 7.5"></path>
              <path d="M5 9.5V20h14V9.5"></path>
            </svg>
          </span>
          <span class="view-tab-label" data-i18n="tab_overview">总览</span>
        </button>
        <button
          id="tab-stats"
          class="view-tab"
          type="button"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-stats"
          data-tab-target="stats"
          data-i18n-aria-label="tab_stats"
        >
          <span class="view-tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
              <path d="M4 20h16"></path>
              <path d="M7 20v-6"></path>
              <path d="M12 20v-10"></path>
              <path d="M17 20v-14"></path>
            </svg>
          </span>
          <span class="view-tab-label" data-i18n="tab_stats">数据统计</span>
        </button>
        <button
          id="tab-live"
          class="view-tab"
          type="button"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-live"
          data-tab-target="live"
          data-i18n-aria-label="tab_live"
        >
          <span class="view-tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
              <rect x="3" y="6" width="14" height="12" rx="2"></rect>
              <path d="M17 10l4-2v8l-4-2z"></path>
            </svg>
          </span>
          <span class="view-tab-label" data-i18n="tab_live">实时监控</span>
        </button>
        <button
          id="tab-history"
          class="view-tab"
          type="button"
          role="tab"
          aria-selected="false"
          aria-controls="tab-panel-history"
          data-tab-target="history"
          data-i18n-aria-label="tab_history"
        >
          <span class="view-tab-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false">
              <path d="M12 7v6l4 2"></path>
              <circle cx="12" cy="12" r="8"></circle>
            </svg>
          </span>
          <span class="view-tab-label" data-i18n="tab_history">历史录像</span>
        </button>
      </nav>

      <section id="tab-panel-overview" class="tab-panel active" data-tab-panel="overview" role="tabpanel" aria-labelledby="tab-overview">
        <section class="kpi-grid" id="kpi-grid"></section>

        <section class="panel-group">
          <div class="overview-top-grid">
            <article class="panel panel-overview-photo">
              <div class="panel-head">
                <h2 data-i18n="overview_photo_title">仓鼠精选照片</h2>
                <p data-i18n="overview_photo_desc">从分析视频中自动提取清晰度与构图较好的仓鼠帧。</p>
              </div>
              <div id="featured-photo-box" class="featured-photo-box"></div>
            </article>

            <article class="panel panel-overview-extra">
              <div class="panel-head">
                <h2 data-i18n="overview_extra_title">分析快照</h2>
                <p data-i18n="overview_extra_desc">展示当前分析任务的关键运行数据。</p>
              </div>
              <div id="overview-quick-stats" class="overview-quick-stats"></div>
            </article>
          </div>

          <article class="panel panel-overview-alerts">
            <div class="panel-head">
              <h2 data-i18n="alerts_title">告警流</h2>
              <p data-i18n="alerts_desc">来自越界、健康、补给与环境规则的实时告警</p>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th data-i18n="table_time">时间</th>
                    <th data-i18n="table_severity">等级</th>
                    <th data-i18n="table_type">类型</th>
                    <th data-i18n="table_message">内容</th>
                  </tr>
                </thead>
                <tbody id="alerts-table"></tbody>
              </table>
            </div>
          </article>
        </section>
      </section>

      <section id="tab-panel-stats" class="tab-panel" data-tab-panel="stats" role="tabpanel" aria-labelledby="tab-stats">
        <section class="panel-group">
          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section1_title">1. 虚拟跑轮传感器</h2>
              <p data-i18n="section1_desc">速度、圈数、方向与跑停切换强度</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_speed_rpm">速度与 RPM 时间线（24h）</h3>
                <div id="chart-speed-rpm" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_hourly_distance">小时里程 + 跑停切换次数</h3>
                <div id="chart-hourly-distance" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_direction">方向分布</h3>
                <div id="chart-direction" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_running_streak">连续奔跑时长趋势</h3>
                <div id="chart-running-streak" class="chart"></div>
              </div>
            </div>
          </article>

          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section2_title">2. 空间活跃度与领地分析</h2>
              <p data-i18n="section2_desc">热力图、巡逻路径、区域停留占比与越界检测</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_heatmap">24h 活动热力图</h3>
                <div id="chart-heatmap" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_trajectory">巡逻轨迹</h3>
                <div id="chart-trajectory" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_position_time">时间 vs 区域停留</h3>
                <div id="chart-position-time" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_zone_dwell">区域停留占比</h3>
                <div id="chart-zone-dwell" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_escape">越界时间线</h3>
                <div id="chart-escape" class="chart"></div>
              </div>
            </div>
          </article>

          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section3_title">3. 基于 VLM 的生理健康扫描</h2>
              <p data-i18n="section3_desc">毛发、神态、体型变化与步态对称性</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_health_radar">最新健康雷达图</h3>
                <div id="chart-health-radar" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_health_trend">健康扫描趋势</h3>
                <div id="chart-health-trend" class="chart"></div>
              </div>
            </div>
          </article>

          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section4_title">4. 资源状态监控</h2>
              <p data-i18n="section4_desc">水位、粮食余量、藏粮热点和磨牙损耗</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_resource">水位 / 食量趋势</h3>
                <div id="chart-resource" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_gnaw">磨牙损耗趋势</h3>
                <div id="chart-gnaw" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_hoard">藏粮热点</h3>
                <div id="chart-hoard" class="chart"></div>
              </div>
            </div>
          </article>

          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section5_title">5. 行为习性与作息统计</h2>
              <p data-i18n="section5_desc">起居规律、洗脸频率、刻板行为与挖掘时长</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_behavior_hourly">每小时洗脸 / 挖掘</h3>
                <div id="chart-behavior-hourly" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_anxiety">焦虑 / 刻板行为指数</h3>
                <div id="chart-anxiety" class="chart"></div>
              </div>
              <div class="chart-box schedule-box">
                <h3 data-i18n="chart_schedule">每日作息快照</h3>
                <div id="schedule-card" class="schedule-card"></div>
              </div>
            </div>
          </article>

          <article class="panel panel-wide">
            <div class="panel-head">
              <h2 data-i18n="section6_title">6. 生活环境与运动分析</h2>
              <p data-i18n="section6_desc">光照、清洁、垫料舒适度与画面变动分析</p>
            </div>
            <div class="chart-grid chart-grid-2">
              <div class="chart-box">
                <h3 data-i18n="chart_env_comfort">环境舒适度趋势</h3>
                <div id="chart-env-comfort" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_env_factors">环境因子分项</h3>
                <div id="chart-env-factors" class="chart"></div>
              </div>
              <div class="chart-box">
                <h3 data-i18n="chart_motion">运动比率与分析触发</h3>
                <div id="chart-motion" class="chart"></div>
              </div>
            </div>
          </article>
        </section>
      </section>

      <section id="tab-panel-live" class="tab-panel" data-tab-panel="live" role="tabpanel" aria-labelledby="tab-live">
        <article class="panel panel-live">
          <div class="panel-head">
            <h2 data-i18n="tab_live_title">实时监控</h2>
            <p data-i18n="tab_live_desc">真实模式显示 CSI 摄像头流；演示模式可回放上传视频。</p>
          </div>
          <div class="live-player-wrap">
            <video
              id="live-upload-video"
              class="live-player"
              controls
              muted
              loop
              playsinline
              preload="metadata"
            ></video>
            <img id="live-real-image" class="live-player hidden" alt="Real camera stream" />
            <p id="live-upload-status" class="live-status">请先上传并选择视频。</p>
          </div>
        </article>
      </section>

      <section id="tab-panel-history" class="tab-panel" data-tab-panel="history" role="tabpanel" aria-labelledby="tab-history">
        <article class="panel panel-live">
          <div class="panel-head">
            <h2 data-i18n="history_title">历史录像</h2>
            <p data-i18n="history_desc">按日期和24小时选择历史录像，拖动时间轴查看该小时画面。</p>
          </div>
          <div class="history-toolbar">
            <p id="history-recordings-summary" class="live-status"></p>
            <button id="history-refresh-btn" class="btn btn-ghost btn-xs" data-i18n="history_btn_refresh">刷新录像列表</button>
          </div>
          <div class="history-layout">
            <div id="history-recordings-list" class="history-recordings-list">
              <div class="history-selector-block">
                <p class="history-selector-label" data-i18n="history_filter_date">日期</p>
                <div class="history-date-list"></div>
              </div>
              <div class="history-selector-block">
                <p class="history-selector-label" data-i18n="history_filter_hours">24小时</p>
                <div class="history-hour-grid"></div>
              </div>
            </div>
            <div class="history-player-wrap">
              <video id="history-recording-video" class="live-player history-player" controls playsinline preload="metadata"></video>
              <div class="history-timeline">
                <input id="history-timeline-slider" class="history-timeline-slider" type="range" min="0" max="0" step="0.1" value="0" disabled />
                <p class="history-timeline-text">
                  <span id="history-current-time">00:00</span>
                  <span id="history-total-time">00:00</span>
                </p>
                <p id="history-hour-range" class="history-hour-range"></p>
              </div>
              <div id="history-recording-meta" class="history-recording-meta"></div>
            </div>
          </div>
          <p id="history-recordings-status" class="live-status">暂无录像。</p>
        </article>
      </section>
    </main>

    <div id="init-modal" class="modal hidden">
      <div class="modal-panel">
        <div class="modal-head">
          <h2 data-i18n="init_title">初始化笼内区域</h2>
          <button id="init-close" class="btn btn-ghost btn-xs" data-i18n="btn_close">关闭</button>
        </div>
        <p class="modal-sub" data-i18n="init_sub">
          单击添加点位，双击闭合多边形。请依次完成所有区域后保存。
        </p>

        <div class="init-layout">
          <div class="init-preview-stack">
            <div class="init-canvas-wrap">
              <canvas id="init-canvas"></canvas>
            </div>
            <section id="init-map-compare" class="init-map-compare hidden">
              <div class="init-map-head">
                <h3 data-i18n="init_map_title">圈区映射预览</h3>
                <p class="init-map-desc" data-i18n="init_map_desc">用于快速核对映射前后区域形变是否合理。</p>
              </div>
              <div class="init-map-grid">
                <figure class="init-map-card">
                  <figcaption data-i18n="init_map_before">映射前（相机平面）</figcaption>
                  <div class="init-map-canvas-wrap">
                    <canvas id="init-map-before-canvas"></canvas>
                  </div>
                </figure>
                <figure class="init-map-card">
                  <figcaption data-i18n="init_map_after">映射后（长方形平面）</figcaption>
                  <div class="init-map-canvas-wrap">
                    <canvas id="init-map-after-canvas"></canvas>
                  </div>
                </figure>
              </div>
              <p id="init-map-status" class="modal-sub"></p>
            </section>
          </div>
          <div class="init-controls">
            <div class="init-step-card">
              <p class="init-label" data-i18n="init_current">当前区域</p>
              <h3 id="init-current-region">-</h3>
              <p id="init-current-desc" class="init-desc">-</p>
            </div>

            <div class="init-btn-grid">
              <button id="init-undo" class="btn btn-ghost btn-xs" data-i18n="btn_undo">撤销点位</button>
              <button id="init-clear" class="btn btn-ghost btn-xs" data-i18n="btn_clear">清空区域</button>
              <button id="init-prev" class="btn btn-ghost btn-xs" data-i18n="btn_prev">上一区域</button>
              <button id="init-next" class="btn btn-ghost btn-xs" data-i18n="btn_next">下一区域</button>
            </div>

            <div class="init-step-list" id="init-step-list"></div>

            <button id="init-save" class="btn btn-solid" data-i18n="btn_save_regions">保存区域到配置</button>
            <p id="init-status" class="modal-sub"></p>
          </div>
        </div>
      </div>
    </div>

    <div id="settings-modal" class="modal hidden">
      <div class="modal-panel">
        <div class="modal-head">
          <h2 data-i18n="settings_title">系统设置</h2>
          <button id="settings-close" class="btn btn-ghost btn-xs" data-i18n="btn_close">关闭</button>
        </div>
        <p class="modal-sub" data-i18n="settings_sub">可编辑全部配置项，并设置默认语言。</p>

        <div class="settings-grid">
          <aside class="settings-tools settings-sidebar">
            <p class="settings-label" data-i18n="settings_section_title">配置分组</p>
            <div id="settings-section-list" class="settings-section-list"></div>

            <p id="settings-status" class="modal-sub"></p>
          </aside>

          <section class="settings-editor-wrap">
            <div class="settings-mobile-nav">
              <button id="settings-mobile-back" type="button" class="btn btn-ghost btn-xs hidden" data-i18n="settings_mobile_back">
                返回分组
              </button>
            </div>
            <p id="settings-section-title" class="settings-label">-</p>
            <p id="settings-section-desc" class="modal-sub"></p>

            <div id="settings-config-form" class="settings-form"></div>

            <div id="settings-upload-block" class="settings-upload hidden">
              <label for="settings-uploaded-select" class="settings-label" data-i18n="settings_uploaded_select_label">选择已上传视频</label>
              <select id="settings-uploaded-select" class="settings-select">
                <option value="" data-i18n="upload_history_none">暂无可选视频</option>
              </select>
              <div class="settings-btns settings-btns-single">
                <button id="settings-use-uploaded" class="btn btn-ghost btn-xs" data-i18n="btn_use_uploaded_video">使用并初始化圈区</button>
              </div>
              <label for="settings-video-file" class="settings-label" data-i18n="settings_upload_label">上传视频文件</label>
              <input id="settings-video-file" type="file" class="settings-file" accept="video/mp4,video/quicktime,video/x-msvideo,video/x-matroska,video/m4v,video/webm" />
              <div class="settings-btns settings-btns-single">
                <button id="settings-upload" class="btn btn-ghost btn-xs" data-i18n="btn_upload_video">上传视频</button>
              </div>
              <p id="settings-upload-status" class="modal-sub"></p>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="/web/app.js?v=20260227r4" type="module"></script>
  </body>
</html>
